name: Notify Parent Repo

on:
  push:
    branches: [main]
  repository_dispatch:
    types: [dependency-updated]

jobs:
  wait-for-ci:
    runs-on: ubuntu-latest
    steps:
      - name: Wait for CI
        uses: lewagon/wait-on-check-action@v1.5.0
        with:
          ref: ${{ github.sha }}
          check-name: 'Test (ubuntu-latest)'
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          wait-interval: 10

  notify-parent:
    needs: wait-for-ci
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Determine source
        id: source
        env:
          EVENT_NAME: ${{ github.event_name }}
          PAYLOAD_REPO: ${{ github.event.client_payload.repo }}
          PAYLOAD_REPO_NAME: ${{ github.event.client_payload.repo_name }}
          PAYLOAD_SHA: ${{ github.event.client_payload.sha }}
          PAYLOAD_SHORT_SHA: ${{ github.event.client_payload.short_sha }}
          PAYLOAD_MESSAGE: ${{ github.event.client_payload.message }}
          PAYLOAD_TYPE: ${{ github.event.client_payload.type }}
          PAYLOAD_ACTOR: ${{ github.event.client_payload.actor }}
          GH_REPOSITORY: ${{ github.repository }}
          GH_REPO_NAME: ${{ github.event.repository.name }}
          GH_ACTOR: ${{ github.actor }}
        run: |
          write_output() {
            local key="$1" value="$2"
            local delim="__EOF__$(date +%s%N)_$RANDOM"
            {
              printf '%s<<%s\n' "$key" "$delim"
              printf '%s\n' "$value"
              printf '%s\n' "$delim"
            } >> "$GITHUB_OUTPUT"
          }

          if [ "$EVENT_NAME" = "repository_dispatch" ]; then
            write_output repo "$PAYLOAD_REPO"
            write_output repo_name "$PAYLOAD_REPO_NAME"
            write_output sha "$PAYLOAD_SHA"
            write_output short_sha "$PAYLOAD_SHORT_SHA"
            write_output message "$PAYLOAD_MESSAGE"
            write_output type "$PAYLOAD_TYPE"
            write_output actor "$PAYLOAD_ACTOR"
          else
            MSG=$(git log -1 --pretty=%s)
            write_output message "$MSG"
            write_output repo "$GH_REPOSITORY"
            write_output repo_name "$GH_REPO_NAME"
            write_output actor "$GH_ACTOR"
            write_output sha "$(git rev-parse HEAD)"
            write_output short_sha "$(git rev-parse --short HEAD)"
            re_feat='^feat[:(]'; re_fix='^fix[:(]'; re_chore='^chore[:(]'
            re_docs='^docs[:(]'; re_test='^test[:(]'; re_refactor='^refactor[:(]'
            if [[ "$MSG" =~ $re_feat ]]; then write_output type "feat"
            elif [[ "$MSG" =~ $re_fix ]]; then write_output type "fix"
            elif [[ "$MSG" =~ $re_chore ]]; then write_output type "chore"
            elif [[ "$MSG" =~ $re_docs ]]; then write_output type "docs"
            elif [[ "$MSG" =~ $re_test ]]; then write_output type "test"
            elif [[ "$MSG" =~ $re_refactor ]]; then write_output type "refactor"
            else write_output type "other"
            fi
          fi

      - name: Notify parent repo
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.PARENT_REPO_PAT }}
          repository: harmony-labs/meta
          event-type: child-repo-updated
          client-payload: >-
            {
              "repo": ${{ toJSON(steps.source.outputs.repo) }},
              "repo_name": ${{ toJSON(steps.source.outputs.repo_name) }},
              "sha": ${{ toJSON(steps.source.outputs.sha) }},
              "short_sha": ${{ toJSON(steps.source.outputs.short_sha) }},
              "message": ${{ toJSON(steps.source.outputs.message) }},
              "type": ${{ toJSON(steps.source.outputs.type) }},
              "actor": ${{ toJSON(steps.source.outputs.actor) }}
            }
